var tempMarker;

function onMapClick(e) {
  if (tempMarker) map.removeLayer(tempMarker);

  tempMarker = L.marker(e.latlng).addTo(map);

  tempMarker.bindPopup(`
    <b>เพิ่มหมุดใหม่</b><br>
    <input type="text" id="popupName" placeholder="ชื่อสถานที่" /><br>
    <textarea id="popupAddress" placeholder="ที่อยู่ (ถ้ามี)"></textarea><br>
    <textarea id="popupDetail" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"></textarea><br>
    <button onclick="savePopupMarker()">บันทึก</button>
  `).openPopup();

  window.clickedLatLng = e.latlng;
}

map.on('click', onMapClick);

async function savePopupMarker() {
  const title = document.getElementById('popupName').value.trim();
  const address = document.getElementById('popupAddress').value.trim();
  const detail = document.getElementById('popupDetail').value.trim();

  if (!title) {
    alert('กรุณากรอกชื่อสถานที่');
    return;
  }

  const { lat, lng } = window.clickedLatLng;

  const payload = { title, lat, lon: lng, address, detail };

  const res = await fetch('/add_marker', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  const result = await res.json();

  if (res.ok) {
    alert('เพิ่มหมุดสำเร็จ');
    map.removeLayer(tempMarker);
    tempMarker = null;
    loadMarkers();
  } else {
    alert('ผิดพลาด: ' + result.error);
  }
}
