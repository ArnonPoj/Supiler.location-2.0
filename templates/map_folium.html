var map = L.map('mapid').setView([13.7563, 100.5018], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

var markers = [];

function loadMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  fetch('/markers').then(r => r.json()).then(data => {
    data.forEach(m => {
      const popupContent = 
        `<b>${m.title}</b><br>
        <b>OLC:</b> ${m.olc || '-'}<br>
        <b>ที่อยู่:</b> ${m.address || '-'}<br>
        <b>รายละเอียด:</b> ${m.detail || '-'}`;
      const marker = L.marker([m.lat, m.lon])
        .addTo(map)
        .bindPopup(popupContent)
        .bindTooltip(m.title || 'No title');
      markers.push(marker);
    });
  });
}
loadMarkers();

var tempMarker;
var clickedLatLng = null;

// --- แก้ไข onMapClick --- //
function onMapClick(e) {
  if (tempMarker) map.removeLayer(tempMarker);
  tempMarker = L.marker(e.latlng).addTo(map);
  clickedLatLng = e.latlng;

  // แสดงฟอร์ม popup (div fixed) แทน Leaflet popup
  showPopupForm();

}
map.on('click', onMapClick);

// --- ฟังก์ชันแสดง form popup --- //
function showPopupForm() {
  document.getElementById('popupForm').style.display = 'block';
  // เคลียร์ค่าใน form
  document.getElementById('popupName').value = '';
  document.getElementById('popupAddress').value = '';
  document.getElementById('popupDetail').value = '';
}

// --- ฟังก์ชันซ่อน form popup --- //
function hidePopupForm() {
  document.getElementById('popupForm').style.display = 'none';
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
    clickedLatLng = null;
  }
}

// --- เมื่อกดปุ่มบันทึกในฟอร์ม popup --- //
document.getElementById('savePopupBtn').onclick = async function() {
  const title = document.getElementById('popupName').value.trim();
  const address = document.getElementById('popupAddress').value.trim();
  const detail = document.getElementById('popupDetail').value.trim();
  if (!title) {
    alert('กรุณากรอกชื่อสถานที่');
    return;
  }
  if (!clickedLatLng) {
    alert('ตำแหน่งไม่ถูกต้อง');
    return;
  }
  const {lat, lng} = clickedLatLng;
  const payload = {title, lat, lon: lng, address, detail};
  const res = await fetch('/add_marker', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  const result = await res.json();
  if (res.ok) {
    alert('เพิ่มหมุดสำเร็จ');
    hidePopupForm();
    loadMarkers();
  } else {
    alert('ผิดพลาด: ' + result.error);
  }
};

// --- ปุ่มยกเลิกในฟอร์ม popup --- //
document.getElementById('cancelPopupBtn').onclick = function() {
  hidePopupForm();
};

// --- แก้ไขปุ่ม floatBtn --- //
document.getElementById("floatBtn").onclick = function() {
  // ถ้าเปิดฟอร์มอยู่แล้วให้ซ่อนก่อน
  if (document.getElementById('popupForm').style.display === 'block') {
    hidePopupForm();
    return;
  }

  // เคลียร์ตำแหน่ง tempMarker ถ้ามี
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
  clickedLatLng = null;

  // แสดงฟอร์ม popup (div fixed) สำหรับเพิ่มหมุดจาก OLC
  document.getElementById('popupForm').style.display = 'block';
  document.getElementById('popupName').value = '';
  document.getElementById('popupAddress').value = '';
  document.getElementById('popupDetail').value = '';

  // เพิ่มช่องกรอก OLC ในฟอร์มนี้ โดยเราจะใส่ช่อง OLC เพิ่มเติมแบบ prompt
  // หรือถ้าจะเพิ่มช่องใน div ก็ต้องแก้โครงสร้าง HTML form ด้านบนให้มี input olc ด้วย
  // แต่ผมแนะนำให้ popupForm นี้ใช้แค่กรอกชื่อ, ที่อยู่, รายละเอียด ส่วน OLC ไว้ทำแยก

  // **ถ้าต้องการให้กรอก OLC ด้วย ให้เพิ่ม input OLC ใน popupForm และแก้ฟังก์ชันบันทึกตามนี้**
};
